<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="wasm_exec.js"></script>
    <title>WASM Integration Test</title>
    <style>
      @import url("https://fonts.googleapis.com/css?family=Red+Hat+Display");

      button {
        width: 100%;
        position: fixed;
        padding: 10px;
        top: 10;
        bottom: 0;
        left: 0;
        right: 0;
        font-family: "Red Hat Display", sans-serif;
        z-index: 99;
        font-weight: 600;
        font-size: 14px;
        color: #fbfbfb;
        background-color: #d14667;
      }

      .header {
        z-index: 99;
        display: flex;
        justify-content: space-between;
        padding: 10px;
        text-align: center;
        background: #fbfbfb;
        opacity: 1;
        color: #333;
        border-radius: 14px;
        box-shadow: 2px 2px #676767;
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
      }

      .logo {
        width: 50px;
        transition: transform 0.3s;
      }

      .logo:hover {
        transform: rotateY(180deg);
      }

      .header-text {
        font-family: "Red Hat Display", sans-serif;
        color: #333;
        transition: color 0.3s;
      }

      .header-text:hover {
        color: #d14667;
        /* //d14667 */
      }

      .left {
        position: relative;
        top: 70px;
        justify-content: flex-start;
        align-items: center;
        width: 100%;
        position: absolute;
        margin: 8px;
        padding: 8px;
        left: 0;
        right: 0;
        margin-bottom: 4px !important;
        font-weight: 700;
        /* padding: 4px; */
      }
      .centered {
        text-align: center;
        display: flex;
        justify-content: space-around;
        position: relative;
        top: 65px;
      }
      container {
        z-index: 1;
        position: relative;
        top: 20px;
        margin-top: 30px;
        padding-top: 8px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <img
        class="logo"
        src="https://github.com/defenseunicorns/pepr/raw/main/.images/pepr.png"
        height="50px"
      />
      <h3 class="header-text">Image Transform Vertical</h3>
      <img
        class="logo"
        src="https://github.com/defenseunicorns/zarf/raw/main/.images/zarf-logo.png"
        height="50px"
      />
    </div>

    <script>
      const go = new Go();
      WebAssembly.instantiateStreaming(
        fetch("main.wasm"),
        go.importObject
      ).then(result => {
        go.run(result.instance);
      });
    </script>

    <div class="centered">
      <h4>Pepr Request</h4>
      <h4>Tranformed Pod</h4>
    </div>
    <container>
      <pre id="podPre">
{
  "Raw": {
    "kind": "Pod",
    "apiVersion": "v1",
    "metadata": {
      "name": "test-nginx",
      "namespace": "pepr-demo",
      "creationTimestamp": null,
      "labels": {
        "run": "test-nginx"
      },
      "managedFields": [
        {
          "manager": "kubectl-run",
          "operation": "Update",
          "apiVersion": "v1",
          "time": "2023-07-19T17:08:49Z",
          "fieldsType": "FieldsV1",
          "fieldsV1": {
            "f:metadata": {
              "f:labels": {
                ".": {},
                "f:run": {}
              }
            },
            "f:spec": {
              "f:containers": {
                "k:{\"name\":\"n\"}": {
                  ".": {},
                  "f:image": {},
                  "f:imagePullPolicy": {},
                  "f:name": {},
                  "f:resources": {},
                  "f:terminationMessagePath": {},
                  "f:terminationMessagePolicy": {}
                }
              },
              "f:dnsPolicy": {},
              "f:enableServiceLinks": {},
              "f:restartPolicy": {},
              "f:schedulerName": {},
              "f:securityContext": {},
              "f:terminationGracePeriodSeconds": {}
            }
          }
        }
      ],
      "annotations": {
        "bc6a9d02-8e19-55ae-9306-72fdf34b7ffa.pepr.dev/hello-pepr": "started"
      }
    },
    "spec": {
      "volumes": [
        {
          "name": "kube-api-access-pldrf",
          "projected": {
            "sources": [
              {
                "serviceAccountToken": {
                  "expirationSeconds": 3607,
                  "path": "token"
                }
              },
              {
                "configMap": {
                  "name": "kube-root-ca.crt",
                  "items": [
                    {
                      "key": "ca.crt",
                      "path": "ca.crt"
                    }
                  ]
                }
              },
              {
                "downwardAPI": {
                  "items": [
                    {
                      "path": "namespace",
                      "fieldRef": {
                        "apiVersion": "v1",
                        "fieldPath": "metadata.namespace"
                      }
                    }
                  ]
                }
              }
            ],
            "defaultMode": 420
          }
        }
      ],
      "containers": [
        {
          "name": "test-nginx",
          "image": "nginx",
          "resources": {},
          "volumeMounts": [
            {
              "name": "kube-api-access-pldrf",
              "readOnly": true,
              "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
            }
          ],
          "terminationMessagePath": "/dev/termination-log",
          "terminationMessagePolicy": "File",
          "imagePullPolicy": "Always"
        }
      ],
      "restartPolicy": "Always",
      "terminationGracePeriodSeconds": 30,
      "dnsPolicy": "ClusterFirst",
      "serviceAccountName": "default",
      "serviceAccount": "default",
      "securityContext": {},
      "schedulerName": "default-scheduler",
      "tolerations": [
        {
          "key": "node.kubernetes.io/not-ready",
          "operator": "Exists",
          "effect": "NoExecute",
          "tolerationSeconds": 300
        },
        {
          "key": "node.kubernetes.io/unreachable",
          "operator": "Exists",
          "effect": "NoExecute",
          "tolerationSeconds": 300
        }
      ],
      "priority": 0,
      "enableServiceLinks": true,
      "preemptionPolicy": "PreemptLowerPriority"
    },
    "status": {}
  },
  "_input": {
    "uid": "c9825871-3b32-4020-9f9a-5d43a5b1ff23",
    "kind": {
      "group": "",
      "version": "v1",
      "kind": "Pod"
    },
    "resource": {
      "group": "",
      "version": "v1",
      "resource": "pods"
    },
    "requestKind": {
      "group": "",
      "version": "v1",
      "kind": "Pod"
    },
    "requestResource": {
      "group": "",
      "version": "v1",
      "resource": "pods"
    },
    "name": "test-nginx",
    "namespace": "pepr-demo",
    "operation": "CREATE",
    "userInfo": {
      "username": "system:admin",
      "groups": [
        "system:masters",
        "system:authenticated"
      ]
    },
    "object": {
      "kind": "Pod",
      "apiVersion": "v1",
      "metadata": {
        "name": "test-nginx",
        "namespace": "pepr-demo",
        "creationTimestamp": null,
        "labels": {
          "run": "test-nginx"
        },
        "managedFields": [
          {
            "manager": "kubectl-run",
            "operation": "Update",
            "apiVersion": "v1",
            "time": "2023-07-19T17:08:49Z",
            "fieldsType": "FieldsV1",
            "fieldsV1": {
              "f:metadata": {
                "f:labels": {
                  ".": {},
                  "f:run": {}
                }
              },
              "f:spec": {
                "f:containers": {
                  "k:{\"name\":\"n\"}": {
                    ".": {},
                    "f:image": {},
                    "f:imagePullPolicy": {},
                    "f:name": {},
                    "f:resources": {},
                    "f:terminationMessagePath": {},
                    "f:terminationMessagePolicy": {}
                  }
                },
                "f:dnsPolicy": {},
                "f:enableServiceLinks": {},
                "f:restartPolicy": {},
                "f:schedulerName": {},
                "f:securityContext": {},
                "f:terminationGracePeriodSeconds": {}
              }
            }
          }
        ]
      },
      "spec": {
        "volumes": [
          {
            "name": "kube-api-access-pldrf",
            "projected": {
              "sources": [
                {
                  "serviceAccountToken": {
                    "expirationSeconds": 3607,
                    "path": "token"
                  }
                },
                {
                  "configMap": {
                    "name": "kube-root-ca.crt",
                    "items": [
                      {
                        "key": "ca.crt",
                        "path": "ca.crt"
                      }
                    ]
                  }
                },
                {
                  "downwardAPI": {
                    "items": [
                      {
                        "path": "namespace",
                        "fieldRef": {
                          "apiVersion": "v1",
                          "fieldPath": "metadata.namespace"
                        }
                      }
                    ]
                  }
                }
              ],
              "defaultMode": 420
            }
          }
        ],
        "containers": [
          {
            "name": "test-nginx",
            "image": "nginx",
            "resources": {},
            "volumeMounts": [
              {
                "name": "kube-api-access-pldrf",
                "readOnly": true,
                "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
              }
            ],
            "terminationMessagePath": "/dev/termination-log",
            "terminationMessagePolicy": "File",
            "imagePullPolicy": "Always"
          }
        ],
        "restartPolicy": "Always",
        "terminationGracePeriodSeconds": 30,
        "dnsPolicy": "ClusterFirst",
        "serviceAccountName": "default",
        "serviceAccount": "default",
        "securityContext": {},
        "schedulerName": "default-scheduler",
        "tolerations": [
          {
            "key": "node.kubernetes.io/not-ready",
            "operator": "Exists",
            "effect": "NoExecute",
            "tolerationSeconds": 300
          },
          {
            "key": "node.kubernetes.io/unreachable",
            "operator": "Exists",
            "effect": "NoExecute",
            "tolerationSeconds": 300
          }
        ],
        "priority": 0,
        "enableServiceLinks": true,
        "preemptionPolicy": "PreemptLowerPriority"
      },
      "status": {}
    },
    "oldObject": null,
    "dryRun": false,
    "options": {
      "kind": "CreateOptions",
      "apiVersion": "meta.k8s.io/v1",
      "fieldManager": "kubectl-run"
    }
  }
}

    
</pre
      >
      <pre id="podPost"></pre>
    </container>
    <button onclick="callPodTransform()">PodTransform</button>
  </body>
  <script>
    targetHost = document.getElementById("targetHost");
    srcReference = document.getElementById("srcReference");
    transformedImage = document.getElementById("transformedImage");
    podPre = document.getElementById("podPre");
    podPost = document.getElementById("podPost");
    let wasmRequest = {};
    function callPodTransform() {
      let transformedPod = JSON.parse(
        podTransform(podPre.innerHTML, "regcred", "gitlab.com/project")
      );
      transformedPod.metadata.managedFields = ["removed"];
      podPost.innerHTML = JSON.stringify(transformedPod, null, 2);
    }

    function callWASMTransformImage() {
      target_host = targetHost.value;
      src_reference = srcReference.value;
      transformedImage.innerHTML = TransformImage(target_host, src_reference);
      //wasmRequest.Args = [target_host,src_reference,TransformImage(target_host, src_reference);]
    }
  </script>
</html>
