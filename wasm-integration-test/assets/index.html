<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <script src="wasm_exec.js"></script>
  <title>WASM Integration Test</title>
  <style>
    .left {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      width: 100%;
      position: absolute;
      left: 0;
      right: 0;
      margin-bottom: 4px !important;
      font-weight: 700;
      /* padding: 4px; */
    }

    container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
  </style>
</head>

<body>
  <div>
    <div style="display: inline-flex">
      WASM Response:
      <main id="transformedImage"></main>
    </div>
    <br />
    targetHost <input type="text" id="targetHost" /> <br />
    srcReference <input type="text" id="srcReference" />
    <button onclick="callWASMTransformImage()">Transform Image</button>
  </div>

  <script>
    const go = new Go();
    WebAssembly.instantiateStreaming(
      fetch("main.wasm"),
      go.importObject
    ).then(result => {
      go.run(result.instance);
    });
  </script>

  <h4 class="left">Admission Review</h4>
  <hr />
  <container>
    <pre id="admissionReviewPre">

{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  "request": {
      "uid": "705ab4f5-6393-11e8-b7cc-42010a800002",
      "kind": {
          "group": "autoscaling",
          "version": "v1",
          "kind": "Scale"
      },
      "resource": {
          "group": "apps",
          "version": "v1",
          "resource": "deployments"
      },
      "subResource": "scale",
      "requestKind": {
          "group": "autoscaling",
          "version": "v1",
          "kind": "Scale"
      },
      "requestResource": {
          "group": "apps",
          "version": "v1",
          "resource": "deployments"
      },
      "requestSubResource": "scale",
      "name": "my-deployment",
      "namespace": "my-namespace",
      "operation": "UPDATE",
      "userInfo": {
          "username": "admin",
          "uid": "014fbff9a07c",
          "groups": [
              "system:authenticated",
              "my-admin-group"
          ],
          "extra": {
              "some-key": [
                  "some-value1",
                  "some-value2"
              ]
          }
      },
      "object": {
          "apiVersion": "autoscaling/v1",
          "kind": "Scale"
      },
      "oldObject": {
          "apiVersion": "autoscaling/v1",
          "kind": "Scale"
      },
      "options": {
          "apiVersion": "meta.k8s.io/v1",
          "kind": "UpdateOptions"
      },
      "dryRun": false
  }
}
</pre>
    <pre id="admissionReviewPost"></pre>
    <button onclick="getWASMRequest()">call getWASMRequest</button>
  </container>

  <h4 class="left">Resource Preview</h4>
  <hr />

  <container>
    <pre id="resourcePre">

{
  "kind": "Pod",
  "apiVersion": "v1",
  "metadata": {
      "name": "nginx",
      "namespace": "my-ns",
      "creationTimestamp": null,
      "labels": {
          "run": "nginx"
      }
  },
  "spec": {
      "containers": [
          {
              "name": "nginx",
              "image": "nginx",
              "resources": {}
          }
      ],
      "restartPolicy": "Always",
      "dnsPolicy": "ClusterFirst"
  },
  "status": {}
}
    
</pre>
    <pre id="resourcePost"></pre>
    <button onclick="callGetResource()">call getResource</button>
  </container>

  <h4 class="left">Pod Preview</h4>
  <hr />

  <container>
    <pre id="podPre">
{
  "Raw": {
    "kind": "Pod",
    "apiVersion": "v1",
    "metadata": {
      "name": "n",
      "namespace": "pepr-demo",
      "creationTimestamp": null,
      "labels": {
        "run": "n"
      },
      "managedFields": [
        {
          "manager": "kubectl-run",
          "operation": "Update",
          "apiVersion": "v1",
          "time": "2023-07-19T17:08:49Z",
          "fieldsType": "FieldsV1",
          "fieldsV1": {
            "f:metadata": {
              "f:labels": {
                ".": {},
                "f:run": {}
              }
            },
            "f:spec": {
              "f:containers": {
                "k:{\"name\":\"n\"}": {
                  ".": {},
                  "f:image": {},
                  "f:imagePullPolicy": {},
                  "f:name": {},
                  "f:resources": {},
                  "f:terminationMessagePath": {},
                  "f:terminationMessagePolicy": {}
                }
              },
              "f:dnsPolicy": {},
              "f:enableServiceLinks": {},
              "f:restartPolicy": {},
              "f:schedulerName": {},
              "f:securityContext": {},
              "f:terminationGracePeriodSeconds": {}
            }
          }
        }
      ],
      "annotations": {
        "bc6a9d02-8e19-55ae-9306-72fdf34b7ffa.pepr.dev/hello-pepr": "started"
      }
    },
    "spec": {
      "volumes": [
        {
          "name": "kube-api-access-pldrf",
          "projected": {
            "sources": [
              {
                "serviceAccountToken": {
                  "expirationSeconds": 3607,
                  "path": "token"
                }
              },
              {
                "configMap": {
                  "name": "kube-root-ca.crt",
                  "items": [
                    {
                      "key": "ca.crt",
                      "path": "ca.crt"
                    }
                  ]
                }
              },
              {
                "downwardAPI": {
                  "items": [
                    {
                      "path": "namespace",
                      "fieldRef": {
                        "apiVersion": "v1",
                        "fieldPath": "metadata.namespace"
                      }
                    }
                  ]
                }
              }
            ],
            "defaultMode": 420
          }
        }
      ],
      "containers": [
        {
          "name": "n",
          "image": "nginx",
          "resources": {},
          "volumeMounts": [
            {
              "name": "kube-api-access-pldrf",
              "readOnly": true,
              "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
            }
          ],
          "terminationMessagePath": "/dev/termination-log",
          "terminationMessagePolicy": "File",
          "imagePullPolicy": "Always"
        }
      ],
      "restartPolicy": "Always",
      "terminationGracePeriodSeconds": 30,
      "dnsPolicy": "ClusterFirst",
      "serviceAccountName": "default",
      "serviceAccount": "default",
      "securityContext": {},
      "schedulerName": "default-scheduler",
      "tolerations": [
        {
          "key": "node.kubernetes.io/not-ready",
          "operator": "Exists",
          "effect": "NoExecute",
          "tolerationSeconds": 300
        },
        {
          "key": "node.kubernetes.io/unreachable",
          "operator": "Exists",
          "effect": "NoExecute",
          "tolerationSeconds": 300
        }
      ],
      "priority": 0,
      "enableServiceLinks": true,
      "preemptionPolicy": "PreemptLowerPriority"
    },
    "status": {}
  },
  "_input": {
    "uid": "c9825871-3b32-4020-9f9a-5d43a5b1ff23",
    "kind": {
      "group": "",
      "version": "v1",
      "kind": "Pod"
    },
    "resource": {
      "group": "",
      "version": "v1",
      "resource": "pods"
    },
    "requestKind": {
      "group": "",
      "version": "v1",
      "kind": "Pod"
    },
    "requestResource": {
      "group": "",
      "version": "v1",
      "resource": "pods"
    },
    "name": "n",
    "namespace": "pepr-demo",
    "operation": "CREATE",
    "userInfo": {
      "username": "system:admin",
      "groups": [
        "system:masters",
        "system:authenticated"
      ]
    },
    "object": {
      "kind": "Pod",
      "apiVersion": "v1",
      "metadata": {
        "name": "n",
        "namespace": "pepr-demo",
        "creationTimestamp": null,
        "labels": {
          "run": "n"
        },
        "managedFields": [
          {
            "manager": "kubectl-run",
            "operation": "Update",
            "apiVersion": "v1",
            "time": "2023-07-19T17:08:49Z",
            "fieldsType": "FieldsV1",
            "fieldsV1": {
              "f:metadata": {
                "f:labels": {
                  ".": {},
                  "f:run": {}
                }
              },
              "f:spec": {
                "f:containers": {
                  "k:{\"name\":\"n\"}": {
                    ".": {},
                    "f:image": {},
                    "f:imagePullPolicy": {},
                    "f:name": {},
                    "f:resources": {},
                    "f:terminationMessagePath": {},
                    "f:terminationMessagePolicy": {}
                  }
                },
                "f:dnsPolicy": {},
                "f:enableServiceLinks": {},
                "f:restartPolicy": {},
                "f:schedulerName": {},
                "f:securityContext": {},
                "f:terminationGracePeriodSeconds": {}
              }
            }
          }
        ]
      },
      "spec": {
        "volumes": [
          {
            "name": "kube-api-access-pldrf",
            "projected": {
              "sources": [
                {
                  "serviceAccountToken": {
                    "expirationSeconds": 3607,
                    "path": "token"
                  }
                },
                {
                  "configMap": {
                    "name": "kube-root-ca.crt",
                    "items": [
                      {
                        "key": "ca.crt",
                        "path": "ca.crt"
                      }
                    ]
                  }
                },
                {
                  "downwardAPI": {
                    "items": [
                      {
                        "path": "namespace",
                        "fieldRef": {
                          "apiVersion": "v1",
                          "fieldPath": "metadata.namespace"
                        }
                      }
                    ]
                  }
                }
              ],
              "defaultMode": 420
            }
          }
        ],
        "containers": [
          {
            "name": "n",
            "image": "nginx",
            "resources": {},
            "volumeMounts": [
              {
                "name": "kube-api-access-pldrf",
                "readOnly": true,
                "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
              }
            ],
            "terminationMessagePath": "/dev/termination-log",
            "terminationMessagePolicy": "File",
            "imagePullPolicy": "Always"
          }
        ],
        "restartPolicy": "Always",
        "terminationGracePeriodSeconds": 30,
        "dnsPolicy": "ClusterFirst",
        "serviceAccountName": "default",
        "serviceAccount": "default",
        "securityContext": {},
        "schedulerName": "default-scheduler",
        "tolerations": [
          {
            "key": "node.kubernetes.io/not-ready",
            "operator": "Exists",
            "effect": "NoExecute",
            "tolerationSeconds": 300
          },
          {
            "key": "node.kubernetes.io/unreachable",
            "operator": "Exists",
            "effect": "NoExecute",
            "tolerationSeconds": 300
          }
        ],
        "priority": 0,
        "enableServiceLinks": true,
        "preemptionPolicy": "PreemptLowerPriority"
      },
      "status": {}
    },
    "oldObject": null,
    "dryRun": false,
    "options": {
      "kind": "CreateOptions",
      "apiVersion": "meta.k8s.io/v1",
      "fieldManager": "kubectl-run"
    }
  }
}

    
</pre>
    <pre id="podPost"></pre>
    <button onclick="callPodTransform()">call podTransform</button>
  </container>

</body>
<script>
  targetHost = document.getElementById("targetHost");
  srcReference = document.getElementById("srcReference");
  transformedImage = document.getElementById("transformedImage");
  admissionRequestPre = document.getElementById("admissionReviewPre");
  admissionRequestPost = document.getElementById("admissionReviewPost");
  resourcePre = document.getElementById("resourcePre");
  resourcePost = document.getElementById("resourcePost");
  let wasmRequest = {};
  function callPodTransform() {
    podTransform(podPre.innerHTML);
  }
  function callGetResource() {
    resourcePost.innerHTML = GetResource(resourcePre.innerHTML);
    wasmRequest.Resource = GetResource(resourcePre.innerHTML);
  }
  function callWASMTransformImage() {
    target_host = targetHost.value;
    src_reference = srcReference.value;
    transformedImage.innerHTML = TransformImage(target_host, src_reference);
    //wasmRequest.Args = [target_host,src_reference,TransformImage(target_host, src_reference);]
  }

  function getWASMRequest() {
    let admissionRequest = ConvertAdmissionRequest(
      admissionRequestPre.innerHTML
    );
    console.log("Im working");
    console.log(`wasmRequestEgress: `, JSON.stringify(admissionRequest));
    admissionRequestPost.innerHTML = JSON.stringify(admissionRequest);
    wasmRequest.Request = admissionRequest;
  }
</script>

</html>